name: Train on Vast AI

on:
  workflow_dispatch:
    inputs:
      subpackage:
        description: Subpackage used as root
        default: LightningNowcastingConvLSTM
        required: true
      gpu_name:
        description: GPU used
        default: "RTX_3090"
      image_name:
        description: Image to be used
        default: "glcr.b-data.ch/julia/ver:1.10.6"
      hyperparameter_k_h:
        description: Kernel size hidden to hidden
        default: "5"
      hyperparameter_k_x:
        description: Kernel size input to hidden
        default: "5"
      hyperparameter_hidden:
        description: "# of hidden channels per layer"
        default: "[64, 32, 32]"
      hyperparameter_eta:
        description: Eta for the Optimiser
        default: "3e-3"
      hyperparameter_batchsize:
        description: Minibatch size
        default: "16"
      hyperparameter_use_bias:
        description: Bias term per layer
        default: "[true, false, false]"
      extra_hyperparameters:
        description: Extra hyperparameters in JSON format
        default: '{"n_steps": 20, "seed": 42, "rho": 0.9, "mode": "conditional"}'

env:
  TMUX_SESSION_NAME: "train"

jobs:
  hyperparameters:
    runs-on: [self-hosted, persistent]
    outputs:
      hyperparameters: ${{ steps.hyperparameters.outputs.hyperparameters }}
    steps:
      - id: hyperparameters
        run: |
          echo '${{ toJSON(inputs) }}'
          hyperparameters=$(echo '${{ toJSON(inputs) }}' | jq -cr 'with_entries(select(.key | startswith("hyperparameter_")) | .key |= sub("^hyperparameter_"; ""))')
          final_hyperparameters=$(echo ${hyperparameters} '${{ inputs.extra_hyperparameters }}' | jq -crs add)
          echo "$final_hyperparameters"
          echo "hyperparameters=$final_hyperparameters" >> "$GITHUB_OUTPUT"
  create_instance:
    permissions: write-all
    runs-on: [self-hosted, persistent]
    needs: hyperparameters
    timeout-minutes: 15
    outputs:
      instance_id: ${{ steps.launch.outputs.instance_id }}
      data_url: ${{ steps.data.outputs.data_url }}
      gpu_info: ${{ steps.gpu_info.outputs.gpu_info }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: |
          pip install vastai==0.2.6
      - name: Prepare
        run: ./scripts/prepare.sh
        working-directory: lib/${{ inputs.subpackage }}
      - name: Get Runner Token
        id: get_runner_token
        run: |
          token=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/runners/registration-token | jq -r .token)
          echo "runner_token=$token" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      - name: Launch Instance
        id: launch
        run: python scripts/train.py LAUNCH_INSTANCE
        env:
          VAST_GPU_NAME: ${{ inputs.gpu_name }}
          VAST_IMAGE: ${{ inputs.image_name }}
          VAST_API_KEY: ${{ secrets.VAST_API_KEY }}
          REPO_NAME: ${{ github.repository }}
          SUBPACKAGE: ${{ inputs.subpackage }}
          
          ENV_REPO_NAME: ${{ github.repository }}
          ENV_SUBPACKAGE: ${{ inputs.subpackage }}
          ENV_GITHUB_ACTIONS_TOKEN: ${{ env.runner_token }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_TMUX_SESSION_NAME: ${{ env.TMUX_SESSION_NAME }}
      - name: Copy Data
        id: data
        run: |
          tar -czf data.tar.gz -C ./lib/${{ inputs.subpackage }} data
          key=$(curl -F "file=@data.tar.gz" https://file.io | jq -r .key)
          echo "data_url=https://file.io/$key" >> "$GITHUB_OUTPUT"
      - name: Wait until ready
        id: wait
        run: python scripts/train.py WAIT_INSTANCE
        env:
          INSTANCE_ID: ${{ steps.launch.outputs.instance_id }}
          VAST_API_KEY: ${{ secrets.VAST_API_KEY }}
      - name: Get GPU info
        id: gpu_info
        run: |
          info=$(vastai show instance ${{ steps.launch.outputs.instance_id }} --raw --api-key=${{ secrets.VAST_API_KEY }} | jq -cr 'with_entries(select(.key | startswith("gpu")))')
          echo "gpu_info=$info" >> "$GITHUB_OUTPUT"
  train:
    runs-on: [self-hosted, gpu]
    needs: [create_instance, hyperparameters]
    outputs:
      finished: ${{ steps.train.finished }}
    steps:
      - uses: actions/checkout@v4
      - name: Prepare (Download data and instantiate Julia)
        run: |
          curl -o data.tar.gz ${{ needs.create_instance.outputs.data_url }} &
          (cd lib/${{ inputs.subpackage }} && julia --project=. -e 'import Pkg; Pkg.instantiate()') &
          wait
          tar -xzf data.tar.gz
          cp  --no-clobber -r ./data/* lib/${{ inputs.subpackage }}/data
          tree -hau -L 4 lib/${{ inputs.subpackage }}/data
      - name: Install Packages
        run: julia --project=. -e 'import Pkg; Pkg.instantiate()'
        working-directory: lib/${{ inputs.subpackage }}
      - name: Train
        id: train
        run: |
          tmux new-session -d -s $TMUX_SESSION_NAME 'source ~/.bashrc && bash -c "trap \"sleep 2; rm -f /tmp/$TMUX_SESSION_NAME.log\" EXIT; bash ./scripts/train.sh | tee /tmp/$TMUX_SESSION_NAME.log"'
          if tmux has-session -t $TMUX_SESSION_NAME 2>/dev/null; then
            (timeout 120m tail -f /tmp/$TMUX_SESSION_NAME.log && echo "Session finished") || echo "Session exited or timed out"
          fi
          if tmux has-session -t $TMUX_SESSION_NAME 2>/dev/null; then
            echo "finished=false" >> "$GITHUB_OUTPUT"
          else
            echo "finished=true" >> "$GITHUB_OUTPUT"
          fi
        working-directory: lib/${{ inputs.subpackage }}
        env:
          JULIA_NUM_THREADS: auto
          MLFLOW_TRACKING_URI: http://mlflow.marcovela.com:6969/api
          MLFLOW_TRACKING_USERNAME: lightning
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
          REPOSITORY_URL: https://github.com/${{ github.repository }}.git
          GPU_INFO: ${{ needs.create_instance.outputs.gpu_info }}
          TRAIN_HYPERPARAMETERS: ${{ needs.hyperparameters.outputs.hyperparameters }}
  cleanup:
    runs-on: [self-hosted, persistent]
    needs: [create_instance, train]
    environment: 
      name: ${{ needs.train.outputs.finished == 'false' && 'killer' || 'quick_shot' }}
    if: always()
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Destroy instance
        run: |
          pip install vastai==0.2.6
          vastai destroy instance "${{ needs.create_instance.outputs.instance_id }}" --api-key=${{ secrets.VAST_API_KEY }}
