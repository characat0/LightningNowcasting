name: Train on Vast AI

on:
  workflow_dispatch:
    inputs:
      subpackage:
        description: Subpackage used as root
        required: true
      gpu_name:
        description: GPU used
        default: "RTX_3090"
      image_name:
        description: Image to be used
        default: "glcr.b-data.ch/julia/ver:1.10.6"

jobs:
  run_script:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: |
          pip install vastai==0.2.6
      - name: Prepare
        run: cd lib/${{ inputs.subpackage }} && chmod +x ./scripts/prepare.sh && type ./scripts/prepare.sh && ./scripts/prepare.sh
      - name: Launch Instance
        id: launch
        run: python scripts/train.py LAUNCH_INSTANCE
        env:
          VAST_GPU_NAME: ${{ inputs.gpu_name }}
          VAST_IMAGE: ${{ inputs.image_name }}
          VAST_API_KEY: ${{ secrets.VAST_API_KEY }}
          REPO_NAME: ${{ github.repository }}
          SUBPACKAGE: ${{ inputs.subpackage }}
          MLFLOW_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
      - name: SSH
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" <<< y
          cat ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          vastai attach ssh $(cat ~/.ssh/id_rsa.pub) --api-key=${{ secrets.VAST_API_KEY }}
          ssh_url=$(vastai ssh-url ${{ steps.launch.outputs.instance_id }} --api-key=${{ secrets.VAST_API_KEY }})
          host=$(echo $ssh_url | sed -E 's|ssh://([^@]+)@([^:]+):([0-9]+)|\2|')
          port=$(echo $ssh_url | sed -E 's|ssh://([^@]+)@([^:]+):([0-9]+)|\3|')
          ssh-keyscan -p ${port} ${host} >> ~/.ssh/known_hosts
          ssh -o StrictHostKeyChecking=no ${ssh_url} 'echo "SSH connection successful!"'
      - name: Training
        run: python scripts/train.py START_TRAINING
        env:
          VAST_GPU_NAME: ${{ inputs.gpu_name }}
          VAST_IMAGE: ${{ inputs.image_name }}
          VAST_API_KEY: ${{ secrets.VAST_API_KEY }}
          REPO_NAME: ${{ github.repository }}
          SUBPACKAGE: ${{ inputs.subpackage }}
          MLFLOW_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
          VAST_INSTANCE_ID: ${{ steps.launch.outputs.instance_id }}
